/*

TM1680MatrixGFX.h - Adafruit GFX LED Matrix class for TM1680.
The TM1680MatrixGFX class supports LED matrices of various sizes to be connected
to a TM1680 chip

This library supports modules with following resolutions:
 - TODO

Made by Maxint R&D. See https://github.com/maxint-rd/

*/
#ifndef _TM16XX_MATRIXGFX_H
#define _TM16XX_MATRIXGFX_H

#define TM1680MATRIXGFX_MAXCOLUMNS 16

/*
  // With RGB LEDs TM160 can show 3-bit RGB colors.
  // color: 3 bit RGB: 00000RGB, values 0-7:
  //   Off: 0=Off
  //   Primary colors: 1=Red, 2=Green, 4=Blue. 
  //   Mixed colors:   3=Yellow, 5=Purple, 6=Cyan, 7=White
*/
#define GFX_MATRIX_BLACK 0
#define GFX_MATRIX_RED 1
#define GFX_MATRIX_GREEN 2
#define GFX_MATRIX_BLUE 4
#define GFX_MATRIX_YELLOW 3
#define GFX_MATRIX_MAGENTA 5
#define GFX_MATRIX_CYAN 6
#define GFX_MATRIX_WHITE 7


#define TM1680_MAX_POS 32  // display modes 16x24, 8x32, 24x16, 32x8

#define TM1680_I2C_ADDRESS 0x73   // Regular Arduino I2C requires A0 to be low. Possible 7-bit addresses: 0x73 and 0x72 (0x73: A0 LOW, A1 HIGH or NC; 0x72: A0+A1 LOW)

// Display Commands (see Command Summary Table on page 17 of datasheet v1.1-EN)
#define TM1680_SYS_DIS 0x80    // * sytem disable
#define TM1680_COM_00 0xA0     //   00= 8-com NMOS -> 32SEG x 8COM  => max 32 digits on a 7-segment CA LED display (not tested yet)
#define TM1680_COM_01 0xA4     // * 01=16-com NMOS -> 24SEG x 16COM => max 24 digits on a 15-segment CA LED display (tested 5241BS dual digit, 14-seg + dot)
#define TM1680_COM_02 0xA8     //   10= 8-com PMOS -> 32COM x 8SEG 
#define TM1680_COM_03 0xAC     //   11=16-com PMOS -> 24COM x 16SEG 
#define TM1680_RC_0 0x98       //   RC Master Mode 0 (OSC low, SYN high, single chip)
#define TM1680_RC_1 0x9A       // * RC Master Mode 1 (cascade chip, see datasheet slave mode 0x90, EXT modes 0x9C/0x9E)
#define TM1680_SYS_EN 0x81     // * sytem enable
#define TM1680_LED_OFF 0x82    //   LED off
#define TM1680_LED_ON 0x83     // * LED on
#define TM1680_PWM_DUTY_0 0xB0 // * PWM duty (B0=min, BF=max)
#define TM1680_BLINK_OFF 0x88  // * Blink off
#define TM1680_BLINK_2HZ 0x89  //   Blink 2Hz
#define TM1680_BLINK_1HZ 0x8A  //   Blink 1Hz
#define TM1680_BLINK_05HZ 0x8B //   Blink 0.5Hz


class TM1680MatrixGFX : public Adafruit_GFX
{
 public:
	TM1680MatrixGFX(byte nAddressI2C, byte nColumns, byte nRows);     // TM1680 can use either 0x73 or 0x71
  void begin();
  void setIntensity(byte intensity);		// intensity 0-7, 0=off, 7=bright
  void setMirror(bool fMirrorX=false, bool fMirrorY=false);
//  void fillScreen(uint16_t color);
  void drawPixel(int16_t x, int16_t y, uint16_t color);
  uint16_t getPixel(int16_t x, int16_t y); // required for scroll support as implemented by Adafruit GFX pull request #60
  uint16_t color565(byte nR, byte nG, byte nB); // return RGB color value

  void write();

  void testAllPixels();
  void testBlinkAll(unsigned int uWait=2000);

 protected:
  byte _nAddressI2C;
  
  byte _nColumns;
  byte _nRows;
  bool _fMirrorX;
  bool _fMirrorY;

 private:
 	bool convertToMemPos(int16_t &x, int16_t &y);
  void blinkall(unsigned int uWait=2000);
  void sendfullarray();
  uint16_t getConv(byte x, byte y, byte c);
  void setPixel(byte x, byte y, byte color);
  byte _bitmap[48] = { 0 };     // a full frame of display memory, 96 nibbles for COM16 mode equals 48 bytes
};
#endif


// --- Pixel addressing conversion ----
// We need to map 11*11*3 pixel-leds to a proper bit position in our frame array
// The bit position is somewhere between 0 and 48*8 (=384)
// Each pixel is a combination of three LEDs, some LEDs within the same pixel are at different RAM positions
// Findings:
//   - Some logic in the wiring: columns of five pixels, rows of 5 and 6 pixels
//   - Each column of 5 pixels uses 15 bits, bit 0xB is skipped. Using skipped positions results in faintly lit block.
//   - Using hexadecimal bit locations helps to show the organisation
//   - RAM is 48 bytes, ie. 384 bits. Bits can be numbered 0x00-0x17F.
//   - Last row (#10) has some peculiar wiring to fill up the 11x11 matrix
//   - Pixel 10,10 uses some skipped bits to complete the matrix (0x16B,0x17B,0x15B))
const uint16_t _convarray[11*11*3] = 
{
  //  0 (R,G,B)        1                 2             3               4               5               6                  7                  8                  9                   10    
  0x05,0x04,0x06, 0x15,0x14,0x16, 0x25,0x24,0x26, 0x35,0x34,0x36, 0x45,0x44,0x46, 0x55,0x54,0x56, 0xC5,0xC4,0xC6,    0xD5,0xD4,0xD6,    0xE5,0xE4,0xE6,    0xF5,0xF4,0xF6,    0x105,0x104,0x106,     // 0
  0x00,0x07,0x01, 0x10,0x17,0x11, 0x20,0x27,0x21, 0x30,0x37,0x31, 0x40,0x47,0x41, 0x50,0x57,0x51, 0xC0,0xC7,0xC1,    0xD0,0xD7,0xD1,    0xE0,0xE7,0xE1,    0xF0,0xF7,0xF1,    0x100,0x107,0x101,     // 1
  0x03,0x02,0x0C, 0x13,0x12,0x1C, 0x23,0x22,0x2C, 0x33,0x32,0x3C, 0x43,0x42,0x4C, 0x53,0x52,0x5C, 0xC3,0xC2,0xCC,    0xD3,0xD2,0xDC,    0xE3,0xE2,0xEC,    0xF3,0xF2,0xFC,    0x103,0x102,0x10C,     // 2
  0x0E,0x0D,0x0F, 0x1E,0x1D,0x1F, 0x2E,0x2D,0x2F, 0x3E,0x3D,0x3F, 0x4E,0x4D,0x4F, 0x5E,0x5D,0x5F, 0xCE,0xCD,0xCF,    0xDE,0xDD,0xDF,    0xEE,0xED,0xEF,    0xFE,0xFD,0xFF,    0x10E,0x10D,0x10F,     // 3
  0x09,0x08,0x0A, 0x19,0x18,0x1A, 0x29,0x28,0x2A, 0x39,0x38,0x3A, 0x49,0x48,0x4A, 0x59,0x58,0x5A, 0xC9,0xC8,0xCA,    0xD9,0xD8,0xDA,    0xE9,0xE8,0xEA,    0xF9,0xF8,0xFA,    0x109,0x108,0x10A,     // 4

  0x65,0x64,0x66, 0x75,0x74,0x76, 0x85,0x84,0x86, 0x95,0x94,0x96, 0xA5,0xA4,0xA6, 0xB5,0xB4,0xB6, 0x115,0x114,0x116, 0x125,0x124,0x126, 0x135,0x134,0x136, 0x145,0x144,0x146, 0x155,0x154,0x156,     // 5
  0x60,0x67,0x61, 0x70,0x77,0x71, 0x80,0x87,0x81, 0x90,0x97,0x91, 0xA0,0xA7,0xA1, 0xB0,0xB7,0xB1, 0x110,0x117,0x111, 0x120,0x127,0x121, 0x130,0x137,0x131, 0x140,0x147,0x141, 0x150,0x157,0x151,     // 6
  0x63,0x62,0x6C, 0x73,0x72,0x7C, 0x83,0x82,0x8C, 0x93,0x92,0x9C, 0xA3,0xA2,0xAC, 0xB3,0xB2,0xBC, 0x113,0x112,0x11C, 0x123,0x122,0x12C, 0x133,0x132,0x13C, 0x143,0x142,0x14C, 0x153,0x152,0x15C,     // 7
  0x6E,0x6D,0x6F, 0x7E,0x7D,0x7F, 0x8E,0x8D,0x8F, 0x9E,0x9D,0x9F, 0xAE,0xAD,0xAF, 0xBE,0xBD,0xBF, 0x11E,0x11D,0x11F, 0x12E,0x12D,0x12F, 0x13E,0x13D,0x13F, 0x14E,0x14D,0x14F, 0x15E,0x15D,0x15F,     // 8
  0x69,0x68,0x6A, 0x79,0x78,0x7A, 0x89,0x88,0x8A, 0x99,0x98,0x9A, 0xA9,0xA8,0xAA, 0xB9,0xB8,0xBA, 0x119,0x118,0x11A, 0x129,0x128,0x12A, 0x139,0x138,0x13A, 0x149,0x148,0x14A, 0x159,0x158,0x15A,     // 9
  // 0                     1                  2                  3                  4                  5                  6                  7                  8                  9                10    
  0x165,0x164,0x166, 0x160,0x167,0x161, 0x163,0x162,0x16C, 0x16E,0x16D,0x16F, 0x169,0x168,0x16A, 0x175,0x174,0x176, 0x170,0x177,0x171, 0x173,0x172,0x17C, 0x17E,0x17D,0x17F, 0x179,0x178,0x17A, 0x16B,0x17B,0x15B,          // 10
};
